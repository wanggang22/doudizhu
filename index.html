<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ–—åœ°ä¸» - åœ¨çº¿ä¸‰äººå¯¹æˆ˜</title>
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.4/dist/peerjs.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0d5a2a;font-family:'Microsoft YaHei','PingFang SC',sans-serif;height:100vh;height:100dvh;overflow:hidden;user-select:none;color:#fff}
#game{width:100vw;height:100vh;height:100dvh;position:relative;background:radial-gradient(ellipse at center,#1a7a3a 0%,#0d5a2a 60%,#083a1a 100%);display:flex;flex-direction:column}

#top-bar{display:flex;justify-content:space-around;align-items:center;padding:8px 12px;background:rgba(0,0,0,.3);flex-shrink:0}
.player-tab{display:flex;align-items:center;gap:8px;padding:6px 14px;border-radius:20px;background:rgba(255,255,255,.1);font-size:14px;transition:all .3s}
.player-tab.active{background:rgba(46,204,113,.4);box-shadow:0 0 10px rgba(46,204,113,.3)}
.player-tab.landlord .p-name::after{content:' [åœ°ä¸»]';color:#e74c3c;font-weight:bold}
.player-tab.me{border:1.5px solid rgba(46,204,113,.5)}
.p-name{font-weight:bold}.p-count{color:#adf;font-size:12px}.p-count.zero{color:#e74c3c}

#bottom-cards-bar{display:flex;justify-content:center;align-items:center;gap:6px;padding:4px 0;flex-shrink:0}
#bottom-cards-bar .label{font-size:13px;color:#aaa;margin-right:4px}

#table{flex:1;display:flex;justify-content:space-around;align-items:center;padding:8px 16px;min-height:0}
.table-slot{display:flex;flex-direction:column;align-items:center;min-width:80px}
.table-slot .slot-name{font-size:12px;color:#aaa;margin-bottom:3px}
.table-slot .slot-cards{display:flex;justify-content:center;min-height:64px;align-items:center}
.slot-label{font-size:16px;color:#ffd700;font-weight:bold}

#hand-area{flex-shrink:0;display:flex;flex-direction:column;align-items:center;padding:4px 0 8px;background:rgba(0,0,0,.2);border-top:1px solid rgba(255,255,255,.1)}
#hand-label{font-size:13px;color:#2ecc71;margin-bottom:3px;font-weight:bold}
#hand-cards{display:flex;justify-content:center;flex-wrap:nowrap;padding:18px 10px 0;overflow-x:auto;max-width:100%;min-height:90px}
#controls{display:flex;gap:10px;margin-top:5px;margin-bottom:4px}

.card{width:54px;height:78px;background:#fff;border-radius:5px;border:1.5px solid #bbb;display:inline-flex;flex-direction:column;align-items:flex-start;padding:3px 5px;cursor:pointer;position:relative;transition:transform .15s,box-shadow .15s;box-shadow:1px 2px 4px rgba(0,0,0,.3);flex-shrink:0}
.card:hover{transform:translateY(-5px);box-shadow:1px 4px 8px rgba(0,0,0,.4)}
.card.selected{transform:translateY(-16px);box-shadow:0 6px 12px rgba(0,0,0,.5);border-color:#3498db}
.card.disabled{cursor:default;opacity:.7}.card.disabled:hover{transform:none}
.card .val{font-size:15px;font-weight:bold;line-height:1}.card .suit{font-size:17px;line-height:1;align-self:center;margin-top:2px}
.card.red .val,.card.red .suit{color:#d00}.card.black .val,.card.black .suit{color:#222}
.card.joker-small .val{color:#1a5;font-size:10px}.card.joker-small .suit{font-size:28px;filter:drop-shadow(0 1px 2px rgba(0,0,0,.3))}
.card.joker-big .val{color:#d00;font-size:10px}.card.joker-big .suit{font-size:28px;filter:drop-shadow(0 1px 2px rgba(0,0,0,.3))}
.hand-card{margin-left:-16px}.hand-card:first-child{margin-left:0}
.card-sm{width:42px;height:60px;padding:2px 3px;cursor:default}.card-sm .val{font-size:11px}.card-sm .suit{font-size:13px}
.card-sm:hover{transform:none;box-shadow:1px 2px 4px rgba(0,0,0,.3)}
.table-slot .card-sm{margin-left:-8px}.table-slot .card-sm:first-child{margin-left:0}
.card-xs{width:34px;height:50px;padding:2px;cursor:default}.card-xs .val{font-size:10px}.card-xs .suit{font-size:11px}.card-xs:hover{transform:none}

.btn{padding:7px 22px;font-size:14px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;transition:all .2s;color:#fff}
.btn:hover{transform:scale(1.05)}.btn:disabled{opacity:.4;cursor:default;transform:none}
.btn-play{background:#e67e22}.btn-pass{background:#7f8c8d}.btn-hint{background:#2ecc71}

#overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.78);z-index:200;display:flex;justify-content:center;align-items:center;backdrop-filter:blur(4px)}
#overlay.hidden{display:none}
.overlay-box{background:linear-gradient(135deg,#1a3a2a,#2a5a3a);border:2px solid rgba(46,204,113,.4);border-radius:20px;padding:36px 44px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.5);max-width:92vw;min-width:280px}
.overlay-box h2{font-size:24px;margin-bottom:10px}
.overlay-box p{font-size:15px;color:#ccc;margin-bottom:14px;line-height:1.6}
.overlay-box .sub{font-size:12px;color:#888;margin-top:10px}
.room-code{font-size:42px;font-weight:bold;color:#2ecc71;letter-spacing:8px;margin:12px 0;font-family:monospace}
.btn-big{padding:12px 40px;font-size:18px;border:none;border-radius:12px;cursor:pointer;font-weight:bold;color:#fff;margin:6px;transition:all .2s}
.btn-big:hover{transform:scale(1.05)}.btn-big:disabled{opacity:.4;cursor:default;transform:none}
.btn-ready{background:#27ae60}.btn-bid{background:#e74c3c}.btn-bid.pass{background:#7f8c8d}.btn-restart{background:#e67e22}
input.room-input{width:160px;padding:10px 14px;font-size:20px;text-align:center;border-radius:10px;border:2px solid #2ecc71;background:rgba(0,0,0,.3);color:#fff;letter-spacing:6px;font-family:monospace;text-transform:uppercase;outline:none}
input.room-input:focus{border-color:#3498db}
input.name-input{width:120px;padding:8px 12px;font-size:15px;text-align:center;border-radius:8px;border:1.5px solid #888;background:rgba(0,0,0,.3);color:#fff;outline:none}
.player-list{margin:10px 0;font-size:14px;color:#adf}
.wait-dot::after{content:'';animation:dots 1.5s infinite}
@keyframes dots{0%{content:''}33%{content:'.'}66%{content:'..'}100%{content:'...'}}
#msg{position:absolute;top:38%;left:50%;transform:translate(-50%,-50%);font-size:22px;font-weight:bold;color:#ffd700;text-shadow:2px 2px 6px rgba(0,0,0,.6);pointer-events:none;z-index:150;opacity:0;transition:opacity .3s}
#msg.show{opacity:1}
#music-btn{position:absolute;top:48px;right:10px;z-index:100;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);color:#fff;font-size:20px;width:38px;height:38px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
#music-btn:hover{background:rgba(0,0,0,.6)}
#music-btn.muted{opacity:.4}

@media(max-width:600px){
.card{width:46px;height:66px;padding:2px 3px}.card .val{font-size:13px}.card .suit{font-size:14px}.hand-card{margin-left:-14px}
.card-sm{width:36px;height:52px}.card-sm .val{font-size:9px}.card-sm .suit{font-size:11px}
.card-xs{width:30px;height:44px}
.player-tab{padding:4px 8px;font-size:11px;gap:4px}.btn{padding:6px 14px;font-size:12px}
.overlay-box{padding:24px 20px}.overlay-box h2{font-size:20px}.btn-big{padding:10px 28px;font-size:16px}
.room-code{font-size:34px}input.room-input{width:130px;font-size:18px;padding:8px 10px}
}
</style>
</head>
<body>
<div id="game">
<div id="top-bar">
<span id="room-tag" style="display:none;font-size:11px;color:#adf;background:rgba(0,0,0,.3);padding:3px 8px;border-radius:10px;font-family:monospace;letter-spacing:2px;cursor:pointer" onclick="copyRoomCode()" title="ç‚¹å‡»å¤åˆ¶æˆ¿é—´å·"></span>
<div class="player-tab" id="ptab-0"><span class="p-name" id="pname-0">-</span><span class="p-count" id="pcount-0"></span></div>
<div class="player-tab" id="ptab-1"><span class="p-name" id="pname-1">-</span><span class="p-count" id="pcount-1"></span></div>
<div class="player-tab" id="ptab-2"><span class="p-name" id="pname-2">-</span><span class="p-count" id="pcount-2"></span></div>
</div>
<div id="bottom-cards-bar"><span class="label">åº•ç‰Œ</span><div id="bottom-cards" style="display:flex;gap:3px"></div></div>
<div id="table">
<div class="table-slot"><div class="slot-name" id="sname-0">-</div><div class="slot-cards" id="scards-0"></div></div>
<div class="table-slot"><div class="slot-name" id="sname-1">-</div><div class="slot-cards" id="scards-1"></div></div>
<div class="table-slot"><div class="slot-name" id="sname-2">-</div><div class="slot-cards" id="scards-2"></div></div>
</div>
<div id="hand-area">
<div id="hand-label"></div>
<div id="hand-cards"></div>
<div id="controls" style="display:none">
<button class="btn btn-play" onclick="onPlay()">å‡ºç‰Œ</button>
<button class="btn btn-pass" id="btn-pass" onclick="onPass()">ä¸å‡º</button>
<button class="btn btn-hint" onclick="onHint()">æç¤º</button>
</div>
</div>
<div id="msg"></div>
<button id="music-btn" onclick="toggleMusic()" title="èƒŒæ™¯éŸ³ä¹">&#127925;</button>
<div id="overlay"><div class="overlay-box" id="overlay-box"></div></div>
</div>

<script>
// ============================================
// å¸¸é‡ & ç‰Œç»„å·¥å…·
// ============================================
const SUITS=['â™ ','â™¥','â™¦','â™£'], RED_SUITS=new Set(['â™¥','â™¦']);
const VALUE_ORDER=[3,4,5,6,7,8,9,10,11,12,13,14,15];
const DISPLAY_MAP={3:'3',4:'4',5:'5',6:'6',7:'7',8:'8',9:'9',10:'10',11:'J',12:'Q',13:'K',14:'A',15:'2'};
const PEER_PREFIX='ddz3p-';
let NAMES=['ç©å®¶1','ç©å®¶2','ç©å®¶3'];

function createDeck(){let d=[],id=0;for(let v of VALUE_ORDER){let c=v===15?2:4;for(let i=0;i<c;i++)d.push({id:id++,value:v,suit:SUITS[i],display:DISPLAY_MAP[v]});}d.push({id:id++,value:16,suit:'joker',display:'å°ç‹'});d.push({id:id++,value:17,suit:'joker',display:'å¤§ç‹'});return d}
function shuffle(a){for(let i=a.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}
function sortCards(c){return c.sort((a,b)=>a.value-b.value||SUITS.indexOf(a.suit)-SUITS.indexOf(b.suit))}
function isConsecutive(v){for(let i=1;i<v.length;i++)if(v[i]!==v[i-1]+1)return false;return true}
function groupByValue(c){const m={};c.forEach(x=>{if(!m[x.value])m[x.value]=[];m[x.value].push(x)});return m}

// ============================================
// ç‰Œå‹æ£€æµ‹ & æ¯”è¾ƒ
// ============================================
function detectPlay(cards){
    if(!cards||cards.length===0)return null;
    const s=[...cards].sort((a,b)=>a.value-b.value),n=s.length,grp=groupByValue(s),vals=Object.keys(grp).map(Number).sort((a,b)=>a-b);
    if(n===2&&s[0].value>=16&&s[1].value>=16)return{type:'bomb',bombRank:13};
    if(n===2&&s[0].value===3&&s[1].value===3)return{type:'bomb',bombRank:0};
    if(n===2&&s[0].value===15&&s[1].value===15)return{type:'bomb',bombRank:12};
    if(n===4&&vals.length===1&&vals[0]===3)return{type:'bomb',bombRank:14};
    if(n===4&&vals.length===1&&grp[vals[0]].length===4&&vals[0]!==3)return{type:'bomb',bombRank:vals[0]-3};
    if(n===1)return{type:'single',main:s[0].value};
    if(n===2&&vals.length===1&&vals[0]!==3&&vals[0]!==15)return{type:'pair',main:vals[0]};
    if(n===3&&vals.length===1)return{type:'triple',main:vals[0]};
    if(n===4){for(let v of vals)if(grp[v].length===3)return{type:'triple1',main:v}}
    if(n===6){for(let v of vals)if(grp[v]&&grp[v].length===4){let r=0;vals.forEach(x=>{if(x!==v)r+=grp[x].length});if(r===2)return{type:'four2',main:v}}}
    if(n>=5&&vals.length===n&&vals.every(v=>v>=3&&v<=14)&&isConsecutive(vals))return{type:'straight',main:vals[vals.length-1],len:n};
    if(n>=6&&n%2===0){let ap=vals.every(v=>grp[v].length===2);if(ap&&vals.length>=3&&vals.every(v=>v>=3&&v<=14)&&isConsecutive(vals))return{type:'consec_pairs',main:vals[vals.length-1],len:vals.length}}
    if(n>=6&&n%3===0){let at=vals.every(v=>grp[v].length===3);if(at&&vals.length>=2&&vals.every(v=>v>=3&&v<=14)&&isConsecutive(vals))return{type:'airplane',main:vals[vals.length-1],len:vals.length}}
    if(n>=8&&n%4===0){let k=n/4;if(k>=2){let tv=vals.filter(v=>grp[v]&&grp[v].length>=3&&v>=3&&v<=14).sort((a,b)=>a-b);for(let i=0;i<=tv.length-k;i++){let r=tv.slice(i,i+k);if(isConsecutive(r)&&n-k*3===k)return{type:'airplane1',main:r[r.length-1],len:k}}}}
    return null
}
function canBeat(a,b){if(!b)return a!==null;if(!a)return false;if(a.type==='bomb'&&b.type!=='bomb')return true;if(a.type!=='bomb'&&b.type==='bomb')return false;if(a.type==='bomb'&&b.type==='bomb')return a.bombRank>b.bombRank;if(a.type!==b.type)return false;if(a.len&&a.len!==b.len)return false;return a.main>b.main}
function getBombMul(p){if(!p||p.type!=='bomb')return 1;return p.bombRank===14?8:2}
function getTypeName(p){if(p.type==='bomb'){if(p.bombRank===14)return'å››ä¸ª3 è¶…çº§ç‚¸å¼¹!';if(p.bombRank===13)return'ç«ç®­!';if(p.bombRank===12)return'å¯¹2ç‚¸å¼¹!';if(p.bombRank===0)return'å¯¹3ç‚¸å¼¹!';return'ç‚¸å¼¹!'}return{single:'å•å¼ ',pair:'å¯¹å­',triple:'ä¸‰å¼ ',triple1:'ä¸‰å¸¦ä¸€',four2:'å››å¸¦äºŒ',straight:'é¡ºå­',consec_pairs:'è¿å¯¹',airplane:'é£æœº',airplane1:'é£æœºå¸¦ç¿…è†€'}[p.type]||p.type}

function addBombs(plays,grp,vals,hand){
    if(grp[3]&&grp[3].length>=2)plays.push({cards:grp[3].slice(0,2),type:'bomb',bombRank:0});
    for(let v of vals)if(grp[v].length===4&&v!==3)plays.push({cards:grp[v].slice(),type:'bomb',bombRank:v-3});
    if(grp[15]&&grp[15].length>=2)plays.push({cards:grp[15].slice(0,2),type:'bomb',bombRank:12});
    let sj=hand.find(c=>c.value===16),bj=hand.find(c=>c.value===17);
    if(sj&&bj)plays.push({cards:[sj,bj],type:'bomb',bombRank:13});
    if(grp[3]&&grp[3].length===4)plays.push({cards:grp[3].slice(),type:'bomb',bombRank:14});
}
function findAllPlays(hand,target){
    const plays=[],grp=groupByValue(hand),vals=Object.keys(grp).map(Number).sort((a,b)=>a-b);
    if(!target){
        let seen=new Set();for(let c of hand)if(!seen.has(c.value)){seen.add(c.value);plays.push({cards:[c],type:'single',main:c.value})}
        for(let v of vals)if(grp[v].length>=2&&v!==3&&v!==15)plays.push({cards:grp[v].slice(0,2),type:'pair',main:v});
        for(let v of vals)if(grp[v].length>=3){plays.push({cards:grp[v].slice(0,3),type:'triple',main:v});for(let c of hand){if(c.value!==v){plays.push({cards:[...grp[v].slice(0,3),c],type:'triple1',main:v});break}}}
        let sv=vals.filter(v=>v>=3&&v<=14);
        for(let len=5;len<=sv.length;len++)for(let i=0;i<=sv.length-len;i++){let r=sv.slice(i,i+len);if(isConsecutive(r))plays.push({cards:r.map(v=>grp[v][0]),type:'straight',main:r[r.length-1],len})}
        let pv=vals.filter(v=>grp[v].length>=2&&v>=3&&v<=14);
        for(let len=3;len<=pv.length;len++)for(let i=0;i<=pv.length-len;i++){let r=pv.slice(i,i+len);if(isConsecutive(r)){let cs=[];r.forEach(v=>cs.push(...grp[v].slice(0,2)));plays.push({cards:cs,type:'consec_pairs',main:r[r.length-1],len:r.length})}}
        let tv=vals.filter(v=>grp[v].length>=3&&v>=3&&v<=14);
        for(let len=2;len<=tv.length;len++)for(let i=0;i<=tv.length-len;i++){let r=tv.slice(i,i+len);if(isConsecutive(r)){let cs=[];r.forEach(v=>cs.push(...grp[v].slice(0,3)));plays.push({cards:cs,type:'airplane',main:r[r.length-1],len:r.length})}}
        for(let len=2;len<=tv.length;len++)for(let i=0;i<=tv.length-len;i++){let r=tv.slice(i,i+len);if(isConsecutive(r)){let cs=[];r.forEach(v=>cs.push(...grp[v].slice(0,3)));let uv=new Set(r),w=[];for(let c of hand)if(!uv.has(c.value)&&w.length<len)w.push(c);if(w.length===len){cs.push(...w);let p=detectPlay(cs);if(p)plays.push({cards:cs,...p})}}}
        addBombs(plays,grp,vals,hand);return plays
    }
    if(target.type==='bomb'){
        if(grp[3]&&grp[3].length>=2&&0>target.bombRank)plays.push({cards:grp[3].slice(0,2),type:'bomb',bombRank:0});
        for(let v of vals)if(grp[v].length===4&&v!==3&&(v-3)>target.bombRank)plays.push({cards:grp[v].slice(),type:'bomb',bombRank:v-3});
        if(grp[15]&&grp[15].length>=2&&12>target.bombRank)plays.push({cards:grp[15].slice(0,2),type:'bomb',bombRank:12});
        let sj=hand.find(c=>c.value===16),bj=hand.find(c=>c.value===17);
        if(sj&&bj&&13>target.bombRank)plays.push({cards:[sj,bj],type:'bomb',bombRank:13});
        if(grp[3]&&grp[3].length===4&&14>target.bombRank)plays.push({cards:grp[3].slice(),type:'bomb',bombRank:14});
        return plays
    }
    const tt=target.type;
    if(tt==='single'){let seen=new Set();for(let c of hand)if(c.value>target.main&&!seen.has(c.value)){seen.add(c.value);plays.push({cards:[c],type:'single',main:c.value})}}
    else if(tt==='pair'){for(let v of vals)if(grp[v].length>=2&&v>target.main&&v!==3&&v!==15)plays.push({cards:grp[v].slice(0,2),type:'pair',main:v})}
    else if(tt==='triple'){for(let v of vals)if(grp[v].length>=3&&v>target.main)plays.push({cards:grp[v].slice(0,3),type:'triple',main:v})}
    else if(tt==='triple1'){for(let v of vals)if(grp[v].length>=3&&v>target.main){let tri=grp[v].slice(0,3);for(let c of hand){if(c.value!==v){plays.push({cards:[...tri,c],type:'triple1',main:v});break}}}}
    else if(tt==='four2'){for(let v of vals)if(grp[v].length===4&&v>target.main&&v!==3){let f=grp[v].slice(),s=[];for(let c of hand)if(c.value!==v&&s.length<2)s.push(c);if(s.length===2)plays.push({cards:[...f,...s],type:'four2',main:v})}}
    else if(tt==='straight'){let sv=vals.filter(v=>v>=3&&v<=14);for(let i=0;i<=sv.length-target.len;i++){let r=sv.slice(i,i+target.len);if(isConsecutive(r)&&r[r.length-1]>target.main)plays.push({cards:r.map(v=>grp[v][0]),type:'straight',main:r[r.length-1],len:target.len})}}
    else if(tt==='consec_pairs'){let pv=vals.filter(v=>grp[v].length>=2&&v>=3&&v<=14);for(let i=0;i<=pv.length-target.len;i++){let r=pv.slice(i,i+target.len);if(isConsecutive(r)&&r[r.length-1]>target.main){let cs=[];r.forEach(v=>cs.push(...grp[v].slice(0,2)));plays.push({cards:cs,type:'consec_pairs',main:r[r.length-1],len:target.len})}}}
    else if(tt==='airplane'||tt==='airplane1'){let tv2=vals.filter(v=>grp[v].length>=3&&v>=3&&v<=14).sort((a,b)=>a-b);for(let i=0;i<=tv2.length-target.len;i++){let r=tv2.slice(i,i+target.len);if(isConsecutive(r)&&r[r.length-1]>target.main){let cs=[];r.forEach(v=>cs.push(...grp[v].slice(0,3)));if(tt==='airplane1'){let uv=new Set(r),w=[];for(let c of hand)if(!uv.has(c.value)&&w.length<target.len)w.push(c);if(w.length===target.len)cs.push(...w);else continue}let p=detectPlay(cs);if(p)plays.push({cards:cs,...p})}}}
    addBombs(plays,grp,vals,hand);return plays
}

// ============================================
// ç½‘ç»œå±‚
// ============================================
let NET={peer:null,conns:[null,null],isHost:false,myIndex:-1,roomCode:'',ready:0,
    tokens:['','',''],disconnected:[false,false,false],reconTimers:[null,null,null],
    myToken:'',myName:'',readyStates:[false,false,false]};

function genCode(){const ch='ABCDEFGHJKLMNPQRSTUVWXYZ2345679';let c='';for(let i=0;i<4;i++)c+=ch[Math.floor(Math.random()*ch.length)];return c}
function genToken(){return Math.random().toString(36).substr(2,12)+Date.now().toString(36)}

function hostSend(idx,msg){
    if(idx===0){handleView(msg);return}
    let conn=NET.conns[idx-1];
    if(conn&&conn.open)conn.send(JSON.parse(JSON.stringify(msg)));
}
function hostBroadcast(msgFn){for(let i=0;i<3;i++)hostSend(i,msgFn(i))}
function clientSend(msg){if(NET.conns[0]&&NET.conns[0].open)NET.conns[0].send(msg)}

function setupHostConn(conn,idx){
    conn._idx=idx;
    conn.on('data',data=>{
        if(data.type==='bid')hostHandleBid(idx,data.amount);
        else if(data.type==='play')hostHandlePlay(idx,data.cardIds);
        else if(data.type==='pass')hostHandlePass(idx);
        else if(data.type==='leave')hostHandleLeave(idx);
        else if(data.type==='ready')hostHandleReady(idx);
        else if(data.type==='backToRoom'){NET.readyStates=[false,false,false];resetG();broadcastRoomState()}
    });
    conn.on('close',()=>{
        // æ¸¸æˆæœªå¼€å§‹æ—¶å½“ä½œç¦»å¼€, æ¸¸æˆä¸­å½“ä½œæ–­çº¿
        if(!G.phase||G.phase==='idle')hostHandleLeave(idx);
        else hostHandleDisconnect(idx);
    });
}

function hostHandleDisconnect(idx){
    NET.disconnected[idx]=true;
    hostBroadcast(i=>({type:'message',text:`${NAMES[idx]} æ–­çº¿äº†, ç­‰å¾…é‡è¿(60ç§’)...`,dur:5000}));
    // é€šçŸ¥æ‰€æœ‰å®¢æˆ·ç«¯æš‚åœçŠ¶æ€
    for(let i=1;i<=2;i++){let c=NET.conns[i-1];if(c&&c.open)c.send({type:'paused',who:idx,name:NAMES[idx]})}
    if(idx===0) return; // æˆ¿ä¸»ä¸ä¼šèµ°è¿™é‡Œ
    showOverlay(`<h2>${NAMES[idx]} æ–­çº¿äº†</h2><p>ç­‰å¾…é‡è¿ä¸­<span class="wait-dot"></span></p><p class="sub">60ç§’å†…æœªé‡è¿å°†ç»“æŸæ¸¸æˆ</p>`);
    NET.reconTimers[idx]=setTimeout(()=>{
        if(!NET.disconnected[idx])return;
        let msg=`${NAMES[idx]} è¶…æ—¶æœªé‡è¿, æ¸¸æˆç»“æŸ`;
        showOverlay(`<h2>ç©å®¶ç¦»å¼€</h2><p>${msg}</p><button class="btn-big btn-ready" onclick="showLobby(true)">è¿”å›å¤§å…</button>`);
        for(let i=1;i<=2;i++){let c=NET.conns[i-1];if(c&&c.open)c.send({type:'message',text:msg,dur:10000})}
    },60000);
}

function hostHandleReconnect(conn,idx,token){
    if(idx<1||idx>2||NET.tokens[idx]!==token){conn.close();return false}
    NET.conns[idx-1]=conn;
    NET.disconnected[idx]=false;
    if(NET.reconTimers[idx]){clearTimeout(NET.reconTimers[idx]);NET.reconTimers[idx]=null}
    setupHostConn(conn,idx);
    conn.send({type:'assign',index:idx,names:NAMES,room:NET.roomCode,token:token});
    setTimeout(()=>{
        hostBroadcast(i=>({type:'message',text:`${NAMES[idx]} å·²é‡è¿!`,dur:1500}));
        if(G.phase&&G.phase!=='idle')hostBroadcast(i=>makeView(i));
        hideOverlay();
    },300);
    return true;
}

function hostHandleLeave(idx){
    if(idx<1||idx>2)return;
    let name=NAMES[idx];
    if(NET.conns[idx-1]){try{NET.conns[idx-1].close()}catch(e){}}
    NET.conns[idx-1]=null;
    NAMES[idx]='';NET.tokens[idx]='';
    NET.readyStates[idx]=false;
    NET.ready=Math.max(1,NET.ready-1);
    // é€šçŸ¥æˆ¿é—´å†…å…¶ä»–äºº
    for(let i=0;i<2;i++){let c=NET.conns[i];if(c&&c.open)c.send({type:'message',text:`${name} ç¦»å¼€äº†æˆ¿é—´`,dur:1500})}
    showMsg(`${name} ç¦»å¼€äº†æˆ¿é—´`,1500);
    broadcastRoomState();
}

function hostHandleReady(idx){
    if(idx<0||idx>2)return;
    NET.readyStates[idx]=true;
    broadcastRoomState();
    // 3äººéƒ½å‡†å¤‡äº†, è‡ªåŠ¨å¼€å§‹
    if(NET.ready>=3&&NET.readyStates[0]&&NET.readyStates[1]&&NET.readyStates[2]){
        setTimeout(()=>startOnlineGame(),1000);
    }
}

function broadcastRoomState(){
    let plist=[{name:NAMES[0],index:0,isHost:true,ready:NET.readyStates[0]}];
    for(let i=0;i<2;i++){if(NET.conns[i]&&NET.conns[i].open)plist.push({name:NAMES[i+1],index:i+1,isHost:false,ready:NET.readyStates[i+1]})}
    for(let i=0;i<2;i++){let c=NET.conns[i];if(c&&c.open)c.send({type:'roomState',players:plist,roomCode:NET.roomCode,total:NET.ready})}
    showWaiting();
}

function createRoom(name){
    NET.roomCode=genCode();NET.isHost=true;NET.myIndex=0;NET.ready=1;
    NET.tokens=['host','',''];NET.disconnected=[false,false,false];
    NAMES[0]=name||'ç©å®¶1';
    NET.peer=new Peer(PEER_PREFIX+NET.roomCode,{debug:0});
    NET.peer.on('open',()=>showWaiting());
    NET.peer.on('error',err=>{
        if(err.type==='unavailable-id'){NET.peer.destroy();NET.roomCode=genCode();createRoom(name);return}
        showOverlay(`<h2>è¿æ¥é”™è¯¯</h2><p>${err.message}</p><button class="btn-big btn-ready" onclick="showLobby(true)">è¿”å›</button>`);
    });
    NET.peer.on('connection',conn=>{
        // ç­‰å¾…ç¬¬ä¸€æ¡æ¶ˆæ¯åˆ¤æ–­æ˜¯æ–°åŠ å…¥è¿˜æ˜¯é‡è¿
        let handled=false;
        conn.on('data',function firstMsg(data){
            if(handled)return;handled=true;
            if(data.type==='reconnect'){
                // æ–­çº¿é‡è¿
                if(!hostHandleReconnect(conn,data.index,data.token)){
                    conn.send({type:'message',text:'é‡è¿å¤±è´¥: æ— æ•ˆå‡­è¯',dur:3000});
                    conn.close();
                }
            }else if(data.type==='name'){
                // æ–°ç©å®¶åŠ å…¥
                let idx=!NET.conns[0]||!NET.conns[0].open?1:(!NET.conns[1]||!NET.conns[1].open?2:-1);
                if(idx===-1){conn.send({type:'message',text:'æˆ¿é—´å·²æ»¡',dur:2000});conn.close();return}
                NET.conns[idx-1]=conn;
                NAMES[idx]=data.name||('ç©å®¶'+(idx+1));
                NET.tokens[idx]=genToken();
                NET.ready++;
                setupHostConn(conn,idx);
                conn.send({type:'assign',index:idx,names:NAMES,room:NET.roomCode,token:NET.tokens[idx]});
                // å¹¿æ’­æˆ¿é—´çŠ¶æ€ç»™æ‰€æœ‰äºº
                setTimeout(()=>broadcastRoomState(),200);
            }
        });
    });
}

function joinRoom(code,name){
    NET.roomCode=code.toUpperCase().trim();NET.isHost=false;
    NET.myName=name||'ç©å®¶';
    if(!NET.peer||NET.peer.destroyed){
        NET.peer=new Peer(undefined,{debug:0});
        NET.peer.on('open',()=>connectToHost());
        NET.peer.on('error',err=>{showOverlay(`<h2>è¿æ¥é”™è¯¯</h2><p>${err.message}</p><button class="btn-big btn-ready" onclick="showLobby(true)">è¿”å›</button>`)});
    }else{
        connectToHost();
    }
}

function connectToHost(){
    let conn=NET.peer.connect(PEER_PREFIX+NET.roomCode,{reliable:true});
    let connected=false;
    conn.on('open',()=>{
        connected=true;NET.conns=[conn];
        if(NET.myToken&&NET.myIndex>=0){
            conn.send({type:'reconnect',token:NET.myToken,index:NET.myIndex});
            showOverlay(`<h2>é‡è¿ä¸­</h2><p>æ­£åœ¨æ¢å¤æ¸¸æˆ<span class="wait-dot"></span></p>`);
        }else{
            conn.send({type:'name',name:NET.myName});
            showOverlay(`<h2>åŠ å…¥ä¸­</h2><p>æ­£åœ¨è¿æ¥<span class="wait-dot"></span></p>`);
        }
    });
    conn.on('data',data=>{
        if(data.type==='assign'){
            NET.myIndex=data.index;NAMES=data.names;
            if(data.token)NET.myToken=data.token;
            // ä¿å­˜ä¼šè¯åˆ°sessionStorage, åˆ·æ–°é¡µé¢åå¯æ¢å¤
            try{sessionStorage.setItem('ddz_session',JSON.stringify({room:NET.roomCode,index:NET.myIndex,token:NET.myToken,name:NET.myName}))}catch(e){}
        }
        else if(data.type==='names'){NAMES=data.names}
        else if(data.type==='view')handleView(data);
        else if(data.type==='roomState')showClientRoom(data);
        else if(data.type==='message')showMsg(data.text,data.dur||1500);
        else if(data.type==='paused')showOverlay(`<h2>${data.name} æ–­çº¿äº†</h2><p>ç­‰å¾…é‡è¿ä¸­<span class="wait-dot"></span></p>`);
    });
    conn.on('close',()=>{
        showOverlay(`<h2>è¿æ¥æ–­å¼€</h2><p>æ­£åœ¨å°è¯•é‡è¿<span class="wait-dot"></span></p>`);
        NET._reconAttempts=0;
        attemptReconnect();
    });
    setTimeout(()=>{if(!connected)showOverlay(`<h2>è¿æ¥å¤±è´¥</h2><p>æ‰¾ä¸åˆ°æˆ¿é—´ ${NET.roomCode}</p><button class="btn-big btn-ready" onclick="showLobby(true)">è¿”å›</button>`)},8000);
}

function attemptReconnect(){
    NET._reconAttempts=(NET._reconAttempts||0)+1;
    if(NET._reconAttempts>20){
        showOverlay(`<h2>é‡è¿å¤±è´¥</h2><p>æ— æ³•è¿æ¥åˆ°æˆ¿é—´</p><button class="btn-big btn-ready" onclick="showLobby(true)">è¿”å›å¤§å…</button>`);
        return;
    }
    setTimeout(()=>{
        if(!NET.peer||NET.peer.destroyed){
            NET.peer=new Peer(undefined,{debug:0});
            NET.peer.on('open',()=>connectToHost());
            NET.peer.on('error',()=>{attemptReconnect()});
        }else{
            connectToHost();
        }
    },3000);
}

// ============================================
// æ¸¸æˆçŠ¶æ€ (ä»…æˆ¿ä¸»ç»´æŠ¤)
// ============================================
let G={};
function resetG(){
    G={deck:[],hands:[[],[],[]],bottom:[],landlord:-1,current:0,lastPlay:null,passCount:0,
       phase:'idle',bidder:0,highBid:0,highBidder:-1,bidCount:0,bombMul:1,baseBet:0,
       tableSlots:[{},{},{}]};
}

function makeView(idx){
    return{type:'view',screen:G.phase,myIndex:idx,
        myHand:G.hands[idx],names:NAMES,
        players:[0,1,2].map(i=>({name:NAMES[i],count:G.hands[i].length,isLandlord:G.landlord===i})),
        tableSlots:G.tableSlots,bottomCards:G.bottom,bottomRevealed:G.landlord!==-1,
        current:G.current,isMyTurn:G.current===idx,
        canPass:G.lastPlay!==null&&G.lastPlay.player!==idx,
        lastPlay:G.lastPlay,bidMaxSoFar:G.highBid,
        gameOver:G.phase==='over'?G._overInfo:null}
}

// ============================================
// æ¸¸æˆæµç¨‹ (ä»…æˆ¿ä¸»)
// ============================================
function startOnlineGame(){
    if(NET.isHost&&NET.ready<3){showMsg('éœ€è¦3åç©å®¶æ‰èƒ½å¼€å§‹');return}
    if(NET.isHost&&!(NET.readyStates[0]&&NET.readyStates[1]&&NET.readyStates[2]))return;
    if(!BGM.playing&&!BGM.muted)bgmStart();
    resetG();
    G.deck=createDeck();shuffle(G.deck);
    G.hands[0]=sortCards(G.deck.slice(0,16));
    G.hands[1]=sortCards(G.deck.slice(16,32));
    G.hands[2]=sortCards(G.deck.slice(32,48));
    G.bottom=G.deck.slice(48,52);
    G.phase='bid';G.bidder=Math.floor(Math.random()*3);G.bidCount=0;
    G.tableSlots=[{},{},{}];
    hostBroadcast(i=>({type:'message',text:'æ¸¸æˆå¼€å§‹! å«åœ°ä¸»é˜¶æ®µ',dur:1500}));
    setTimeout(()=>hostBidTurn(),1800);
}

function hostBidTurn(){
    if(G.highBid===3||G.bidCount>=3){hostFinishBid();return}
    G.current=G.bidder;G.phase='bid';
    hostBroadcast(i=>makeView(i));
}

function hostHandleBid(idx,amount){
    if(G.phase!=='bid'||G.current!==idx)return;
    if(amount>0&&amount>G.highBid&&amount<=3){G.highBid=amount;G.highBidder=idx}
    G.bidCount++;G.bidder=(G.bidder+1)%3;
    let text=amount>0?`${NAMES[idx]}: ${amount}åˆ†`:`${NAMES[idx]}: ä¸å«`;
    hostBroadcast(i=>({type:'message',text,dur:1200}));
    setTimeout(()=>hostBidTurn(),1400);
}

function hostFinishBid(){
    if(G.highBidder===-1){
        hostBroadcast(i=>({type:'message',text:'æ²¡äººå«åœ°ä¸», é‡æ–°å‘ç‰Œ!',dur:2000}));
        setTimeout(()=>startOnlineGame(),2500);return;
    }
    G.landlord=G.highBidder;G.baseBet=G.highBid;
    G.hands[G.landlord].push(...G.bottom);sortCards(G.hands[G.landlord]);
    hostBroadcast(i=>({type:'message',text:`${NAMES[G.landlord]} æˆä¸ºåœ°ä¸»!`,dur:2000}));
    G.phase='play';G.current=G.landlord;G.lastPlay=null;G.passCount=0;
    G.tableSlots=[{},{},{}];
    setTimeout(()=>{hostBroadcast(i=>makeView(i))},2200);
}

function hostHandlePlay(idx,cardIds){
    if(G.phase!=='play'||G.current!==idx)return;
    let idSet=new Set(cardIds);
    let selCards=G.hands[idx].filter(c=>idSet.has(c.id));
    if(selCards.length===0)return;
    let play=detectPlay(selCards);
    if(!play){hostSend(idx,{type:'message',text:'æ— æ•ˆç‰Œå‹!'});return}
    let target=(G.lastPlay&&G.lastPlay.player!==idx)?G.lastPlay:null;
    if(target&&!canBeat(play,target)){hostSend(idx,{type:'message',text:'ç®¡ä¸ä½!'});return}
    // valid play
    G.hands[idx]=G.hands[idx].filter(c=>!idSet.has(c.id));
    G.lastPlay={cards:sortCards([...selCards]),...play,player:idx};
    G.passCount=0;G.bombMul*=getBombMul(play);
    G.tableSlots=[{},{},{}];G.tableSlots[idx]={cards:sortCards([...selCards])};
    let text=`${NAMES[idx]}: ${getTypeName(play)}`;
    hostBroadcast(i=>({type:'message',text,dur:1500}));
    if(G.hands[idx].length===0){setTimeout(()=>hostGameOver(idx),1600);return}
    G.current=(idx+1)%3;
    setTimeout(()=>{hostBroadcast(i=>makeView(i))},1800);
}

function hostHandlePass(idx){
    if(G.phase!=='play'||G.current!==idx)return;
    if(G.lastPlay&&G.lastPlay.player===idx)return; // must play
    G.passCount++;
    G.tableSlots[idx]={label:'ä¸å‡º'};
    hostBroadcast(i=>({type:'message',text:`${NAMES[idx]}: ä¸å‡º`,dur:1000}));
    if(G.passCount>=2){G.lastPlay=null;G.passCount=0;G.tableSlots=[{},{},{}]}
    G.current=(idx+1)%3;
    setTimeout(()=>{hostBroadcast(i=>makeView(i))},1400);
}

function hostGameOver(winner){
    G.phase='over';
    let landlordWin=winner===G.landlord,score=G.baseBet*G.bombMul;
    let title,detail;
    if(landlordWin){
        title=`${NAMES[winner]}(åœ°ä¸») è·èƒœ!`;
        let f=[0,1,2].filter(i=>i!==G.landlord);
        detail=`${NAMES[winner]} +${score*2}åˆ† | ${NAMES[f[0]]} -${score}åˆ† | ${NAMES[f[1]]} -${score}åˆ†`;
    }else{
        let f=[0,1,2].filter(i=>i!==G.landlord);
        title=`å†œæ°‘è·èƒœ! ${NAMES[f[0]]} & ${NAMES[f[1]]}`;
        detail=`${NAMES[G.landlord]}(åœ°ä¸») -${score*2}åˆ† | ${NAMES[f[0]]} +${score}åˆ† | ${NAMES[f[1]]} +${score}åˆ†`;
    }
    G._overInfo={title,detail,score,baseBet:G.baseBet,bombMul:G.bombMul};
    hostBroadcast(i=>makeView(i));
}

// ============================================
// å®¢æˆ·ç«¯: æ¥æ”¶è§†å›¾å¹¶æ¸²æŸ“
// ============================================
let VIEW=null, selected=new Set(), hints=[], hintIdx=0;

function handleView(data){
    let v=data.data||data;
    if(v.screen)VIEW=v;
    else if(v.type==='view')VIEW=v;
    else return;
    selected.clear();hints=[];hintIdx=0;
    renderGame();
}

// ============================================
// UI æ¸²æŸ“
// ============================================
function cardHTML(card,extra=''){
    if(!card)return'';
    if(card.value>=16){let cls=card.value===16?'joker-small':'joker-big';let icon=card.value===16?'ğŸƒ':'ğŸ¤¡';return`<div class="card ${cls} ${extra}" data-id="${card.id}"><span class="val">${card.display}</span><span class="suit">${icon}</span></div>`}
    let color=RED_SUITS.has(card.suit)?'red':'black';
    return`<div class="card ${color} ${extra}" data-id="${card.id}"><span class="val">${card.display}</span><span class="suit">${card.suit}</span></div>`
}

function renderGame(){
    if(!VIEW)return;
    hideOverlay();
    let v=VIEW,mi=v.myIndex;
    // room tag
    let rtag=document.getElementById('room-tag');
    if(NET.roomCode){rtag.textContent='æˆ¿é—´ '+NET.roomCode;rtag.style.display=''}
    else rtag.style.display='none';
    // top bar
    for(let i=0;i<3;i++){
        let tab=document.getElementById('ptab-'+i);
        tab.className='player-tab'+(v.current===i?' active':'')+(v.players[i].isLandlord?' landlord':'')+(i===mi?' me':'');
        document.getElementById('pname-'+i).textContent=v.players[i].name+(i===mi?' (ä½ )':'');
        let cnt=document.getElementById('pcount-'+i);
        cnt.textContent=v.players[i].count+'å¼ ';cnt.className='p-count'+(v.players[i].count===0?' zero':'');
    }
    // slot names
    for(let i=0;i<3;i++)document.getElementById('sname-'+i).textContent=v.players[i].name;
    // bottom cards
    let bc=document.getElementById('bottom-cards');
    if(v.bottomRevealed&&v.bottomCards)bc.innerHTML=v.bottomCards.map(c=>cardHTML(c,'card-xs')).join('');
    else bc.innerHTML='<span style="color:#666;font-size:12px">ğŸ‚ ğŸ‚ ğŸ‚ ğŸ‚ </span>';
    // table
    for(let i=0;i<3;i++){
        let el=document.getElementById('scards-'+i);el.innerHTML='';
        let slot=v.tableSlots[i];
        if(slot&&slot.cards)slot.cards.forEach(c=>{el.innerHTML+=cardHTML(c,'card-sm')});
        else if(slot&&slot.label)el.innerHTML=`<span class="slot-label">${slot.label}</span>`;
    }
    // hand
    let hel=document.getElementById('hand-cards');hel.innerHTML='';
    document.getElementById('hand-label').textContent=v.players[mi].name+' çš„æ‰‹ç‰Œ';
    if(v.myHand)v.myHand.forEach(c=>{
        let sel=selected.has(c.id)?'selected':'';
        hel.innerHTML+=cardHTML(c,`hand-card ${sel}`);
    });
    // card click - ä»»ä½•æ—¶å€™éƒ½å¯ä»¥é€‰ç‰Œç ”ç©¶
    hel.querySelectorAll('.card').forEach(el=>{
        el.addEventListener('click',()=>{
            let id=parseInt(el.dataset.id);
            if(selected.has(id)){selected.delete(id);el.classList.remove('selected')}
            else{selected.add(id);el.classList.add('selected')}
        });
    });
    // controls
    let ctrl=document.getElementById('controls');
    if(v.isMyTurn&&v.screen==='play'){ctrl.style.display='flex';document.getElementById('btn-pass').disabled=!v.canPass}
    else ctrl.style.display='none';
    // bid overlay
    if(v.screen==='bid'&&v.isMyTurn)showBidOverlay(v.bidMaxSoFar);
    else if(v.screen==='bid'&&!v.isMyTurn)showOverlay(`<h2>å«åœ°ä¸»é˜¶æ®µ</h2><p>ç­‰å¾… ${v.players[v.current].name} å«åˆ†<span class="wait-dot"></span></p>`);
    // game over
    if(v.screen==='over'&&v.gameOver){
        let o=v.gameOver;
        try{sessionStorage.removeItem('ddz_session')}catch(e){}
        showOverlay(`<h2>${o.title}</h2><p>${o.detail}</p><p style="font-size:13px;color:#888">åº•åˆ† ${o.baseBet} Ã— å€ç‡ ${o.bombMul} = ${o.score}</p><button class="btn-big btn-restart" onclick="backToRoom()">å†æ¥ä¸€å±€</button>`);
    }
}

function showBidOverlay(maxBid){
    let btns='';
    for(let i=maxBid+1;i<=3;i++)btns+=`<button class="btn-big btn-bid" onclick="onBid(${i})">${i}åˆ†</button>`;
    btns+=`<button class="btn-big btn-bid pass" onclick="onBid(0)">ä¸å«</button>`;
    showOverlay(`<h2>è½®åˆ°ä½ å«åœ°ä¸»</h2><div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">${btns}</div>`);
}

function showMsg(text,dur=1500){
    let el=document.getElementById('msg');el.textContent=text;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),dur);
    // éŸ³æ•ˆè§¦å‘ - ä¸åŒç‰Œå‹ä¸åŒå£°éŸ³
    if(text.includes('è¶…çº§ç‚¸å¼¹'))sfxSuperBomb();
    else if(text.includes('ç«ç®­'))sfxRocket();
    else if(text.includes('ç‚¸å¼¹'))sfxBomb();
    else if(text.includes('é£æœº'))sfxAirplane();
    else if(text.includes('é¡ºå­'))sfxStraight();
    else if(text.includes('è¿å¯¹'))sfxConsecPairs();
    else if(text.includes('å››å¸¦'))sfxFour2();
    else if(text.includes('ä¸‰å¸¦'))sfxTriple1();
    else if(text.includes('ä¸‰å¼ '))sfxTriple();
    else if(text.includes('å¯¹å­'))sfxPair();
    else if(text.includes('å•å¼ '))sfxSingle();
    else if(text.includes('ä¸å‡º'))sfxPass();
}
function showOverlay(html){document.getElementById('overlay').classList.remove('hidden');document.getElementById('overlay-box').innerHTML=html}
function hideOverlay(){document.getElementById('overlay').classList.add('hidden')}

function makeSlotHTML(name,tag,isMe,isReady,canReady){
    let right='';
    if(isReady){
        right='<span style="color:#2ecc71;margin-left:auto;font-size:13px;font-weight:bold">&#10003; å·²å‡†å¤‡</span>';
    }else if(canReady){
        right='<button class="btn" style="margin-left:auto;padding:5px 16px;font-size:13px;background:#e67e22" onclick="onReady()">å‡†å¤‡</button>';
    }else{
        right='<span style="color:#f39c12;margin-left:auto;font-size:12px">æœªå‡†å¤‡</span>';
    }
    let bg=isReady?'rgba(46,204,113,.2)':'rgba(46,204,113,.1)';
    let border=isReady?'rgba(46,204,113,.5)':'rgba(46,204,113,.3)';
    return`<div style="padding:10px 14px;background:${bg};border:1.5px solid ${border};border-radius:10px;margin:5px 0;display:flex;align-items:center;gap:8px"><span style="color:#2ecc71;font-size:18px">&#9679;</span><span style="font-weight:bold">${name}${tag}</span>${right}</div>`;
}
function makeEmptySlot(){
    return'<div style="padding:10px 14px;background:rgba(255,255,255,.04);border:1.5px dashed rgba(255,255,255,.15);border-radius:10px;margin:5px 0;color:#666;font-size:13px">&#9711; ç­‰å¾…åŠ å…¥...</div>';
}

function showWaiting(){
    let slots='';
    for(let i=0;i<3;i++){
        let occupied=i===0||(NET.conns[i-1]&&NET.conns[i-1].open&&NAMES[i]);
        if(occupied&&NAMES[i]){
            let tag=i===0?' (æˆ¿ä¸»)':'';
            let isMe=i===0;
            slots+=makeSlotHTML(NAMES[i],tag,isMe,NET.readyStates[i],isMe&&!NET.readyStates[i]);
        }else{
            slots+=makeEmptySlot();
        }
    }
    let rc=NET.readyStates.filter(r=>r).length;
    let info;
    if(NET.ready<3)info=`<p>ç­‰å¾…ç©å®¶åŠ å…¥ (${NET.ready}/3)<span class="wait-dot"></span></p>`;
    else if(rc<3)info=`<p>ç­‰å¾…å…¨å‘˜å‡†å¤‡ (${rc}/3 å·²å‡†å¤‡)<span class="wait-dot"></span></p>`;
    else info='<p style="color:#2ecc71;font-weight:bold">å…¨å‘˜å‡†å¤‡, æ¸¸æˆå³å°†å¼€å§‹!</p>';
    showOverlay(`<h2>æˆ¿é—´</h2><div class="room-code">${NET.roomCode}</div><p style="font-size:13px;color:#aaa">åˆ†äº«æˆ¿é—´å·ç»™æœ‹å‹åŠ å…¥</p><div style="margin:14px 0">${slots}</div>${info}`);
}

function showClientRoom(data){
    let slots='';
    for(let i=0;i<3;i++){
        let p=data.players.find(x=>x.index===i);
        if(p){
            let tag=p.isHost?' (æˆ¿ä¸»)':'';
            let isMe=p.index===NET.myIndex;
            let me=isMe?' (ä½ )':'';
            slots+=makeSlotHTML(p.name+me,tag,isMe,p.ready,isMe&&!p.ready);
        }else{
            slots+=makeEmptySlot();
        }
    }
    let rc=data.players.filter(p=>p.ready).length;
    let info;
    if(data.total<3)info=`<p>ç­‰å¾…ç©å®¶åŠ å…¥ (${data.total}/3)<span class="wait-dot"></span></p>`;
    else if(rc<3)info=`<p>ç­‰å¾…å…¨å‘˜å‡†å¤‡ (${rc}/3 å·²å‡†å¤‡)<span class="wait-dot"></span></p>`;
    else info='<p style="color:#2ecc71;font-weight:bold">å…¨å‘˜å‡†å¤‡, æ¸¸æˆå³å°†å¼€å§‹!</p>';
    showOverlay(`<h2>æˆ¿é—´</h2><div class="room-code">${data.roomCode}</div><div style="margin:14px 0">${slots}</div>${info}<button class="btn-big" style="background:#e74c3c;margin-top:8px" onclick="leaveRoom()">ç¦»å¼€æˆ¿é—´</button>`);
}

// ============================================
// ç©å®¶æ“ä½œ
// ============================================
function onBid(amount){
    hideOverlay();
    if(NET.isHost)hostHandleBid(0,amount);
    else clientSend({type:'bid',amount});
}
function onPlay(){
    if(!VIEW||!VIEW.isMyTurn)return;
    let hand=VIEW.myHand||[];
    let selCards=hand.filter(c=>selected.has(c.id));
    if(selCards.length===0){showMsg('è¯·é€‰æ‹©è¦å‡ºçš„ç‰Œ');return}
    let play=detectPlay(selCards);
    if(!play){showMsg('æ— æ•ˆç‰Œå‹!');return}
    let target=(VIEW.lastPlay&&VIEW.lastPlay.player!==VIEW.myIndex)?VIEW.lastPlay:null;
    if(target&&!canBeat(play,target)){showMsg('ç®¡ä¸ä½!');return}
    let cardIds=selCards.map(c=>c.id);
    if(NET.isHost)hostHandlePlay(0,cardIds);
    else clientSend({type:'play',cardIds});
}
function onPass(){
    if(!VIEW||!VIEW.isMyTurn)return;
    if(NET.isHost)hostHandlePass(0);
    else clientSend({type:'pass'});
}
function onHint(){
    if(!VIEW||!VIEW.isMyTurn||!VIEW.myHand)return;
    let target=(VIEW.lastPlay&&VIEW.lastPlay.player!==VIEW.myIndex)?VIEW.lastPlay:null;
    if(hints.length===0){
        hints=findAllPlays(VIEW.myHand,target);
        hints.sort((a,b)=>{if(a.type==='bomb'&&b.type!=='bomb')return 1;if(a.type!=='bomb'&&b.type==='bomb')return -1;return(a.main||a.bombRank||0)-(b.main||b.bombRank||0)});
        hintIdx=0;
    }
    if(hints.length===0){showMsg('æ²¡æœ‰èƒ½å‡ºçš„ç‰Œ');return}
    let h=hints[hintIdx%hints.length];hintIdx++;
    selected.clear();h.cards.forEach(c=>selected.add(c.id));
    // re-render hand only
    let hel=document.getElementById('hand-cards');
    hel.querySelectorAll('.card').forEach(el=>{
        let id=parseInt(el.dataset.id);
        if(selected.has(id))el.classList.add('selected');else el.classList.remove('selected');
    });
}

// ============================================
// å¤§å…
// ============================================
function showLobby(clearSession){
    if(NET.peer){try{NET.peer.destroy()}catch(e){}}
    NET={peer:null,conns:[null,null],isHost:false,myIndex:-1,roomCode:'',ready:0,
        tokens:['','',''],disconnected:[false,false,false],reconTimers:[null,null,null],
        myToken:'',myName:'',readyStates:[false,false,false]};
    VIEW=null;selected.clear();
    document.getElementById('hand-cards').innerHTML='';
    document.getElementById('hand-label').textContent='';
    document.getElementById('controls').style.display='none';
    for(let i=0;i<3;i++){document.getElementById('scards-'+i).innerHTML='';document.getElementById('pname-'+i).textContent='-';document.getElementById('pcount-'+i).textContent=''}
    document.getElementById('bottom-cards').innerHTML='';
    if(clearSession)try{sessionStorage.removeItem('ddz_session')}catch(e){}
    // æ£€æŸ¥æ˜¯å¦æœ‰å¯æ¢å¤çš„ä¼šè¯
    let resumeHTML='';
    try{
        let saved=sessionStorage.getItem('ddz_session');
        if(saved&&!clearSession){
            let s=JSON.parse(saved);
            if(s.room&&s.token&&s.index>=0){
                resumeHTML=`<div style="border:2px solid #e67e22;border-radius:12px;padding:14px;margin-bottom:18px;background:rgba(230,126,34,.15)">
                    <div style="font-size:15px;font-weight:bold;color:#e67e22;margin-bottom:6px">æ£€æµ‹åˆ°æœªå®Œæˆçš„æ¸¸æˆ</div>
                    <div style="font-size:13px;color:#aaa;margin-bottom:10px">æˆ¿é—´: ${s.room} | æ˜µç§°: ${s.name}</div>
                    <button class="btn-big" style="background:#e67e22" onclick="resumeGame()">æ¢å¤æ¸¸æˆ</button>
                    <button class="btn-big" style="background:#7f8c8d;font-size:14px;padding:8px 16px" onclick="clearAndShowLobby()">æ”¾å¼ƒ</button>
                </div>`;
            }
        }
    }catch(e){}
    showOverlay(`
        <h2>æ–—åœ°ä¸»</h2>
        <p style="font-size:13px;color:#aaa;margin-bottom:18px">åœ¨çº¿ä¸‰äººå¯¹æˆ˜ | è‡ªå®šä¹‰ç‚¸å¼¹è§„åˆ™<br>å¯¹3(æœ€å°) â†’ ç‚¸å¼¹(4~A) â†’ å¯¹2 â†’ ç«ç®­ â†’ å››ä¸ª3(æœ€å¤§)</p>
        ${resumeHTML}
        <div style="margin-bottom:18px">
            <div style="margin-bottom:8px;font-size:13px;color:#aaa">ä½ çš„æ˜µç§°</div>
            <input class="name-input" id="inp-name" placeholder="è¾“å…¥æ˜µç§°" maxlength="8" value="">
        </div>
        <div style="margin-bottom:14px">
            <button class="btn-big btn-ready" onclick="doCreate()">åˆ›å»ºæˆ¿é—´</button>
        </div>
        <div style="border-top:1px solid rgba(255,255,255,.15);padding-top:14px">
            <div style="margin-bottom:8px;font-size:14px">åŠ å…¥æˆ¿é—´</div>
            <input class="room-input" id="inp-room" placeholder="æˆ¿é—´å·" maxlength="4">
            <div style="margin-top:8px"><button class="btn-big btn-ready" onclick="doJoin()">åŠ å…¥</button></div>
        </div>
    `);
}

function doCreate(){
    let name=document.getElementById('inp-name').value.trim()||'ç©å®¶1';
    if(!BGM.playing&&!BGM.muted)bgmStart();
    createRoom(name);
}
function doJoin(){
    let code=document.getElementById('inp-room').value.trim();
    if(code.length!==4){showMsg('è¯·è¾“å…¥4ä½æˆ¿é—´å·');return}
    let name=document.getElementById('inp-name').value.trim()||'ç©å®¶';
    if(!BGM.playing&&!BGM.muted)bgmStart();
    joinRoom(code,name);
}
function copyRoomCode(){
    if(!NET.roomCode)return;
    try{navigator.clipboard.writeText(NET.roomCode);showMsg('æˆ¿é—´å·å·²å¤åˆ¶: '+NET.roomCode,1200)}
    catch(e){showMsg('æˆ¿é—´å·: '+NET.roomCode,2000)}
}
function backToRoom(){
    if(NET.isHost){
        NET.readyStates=[false,false,false];
        resetG();
        broadcastRoomState();
    }else{
        clientSend({type:'backToRoom'});
    }
}
function onReady(){
    if(NET.isHost){
        hostHandleReady(0);
    }else{
        clientSend({type:'ready'});
    }
}
function leaveRoom(){
    if(NET.conns&&NET.conns[0]&&NET.conns[0].open)NET.conns[0].send({type:'leave'});
    try{sessionStorage.removeItem('ddz_session')}catch(e){}
    showLobby(true);
}
function resumeGame(){
    try{
        let saved=JSON.parse(sessionStorage.getItem('ddz_session'));
        if(!saved||!saved.room||!saved.token)return showLobby(true);
        NET.myToken=saved.token;
        NET.myIndex=saved.index;
        NET.myName=saved.name||'ç©å®¶';
        if(!BGM.playing&&!BGM.muted)bgmStart();
        joinRoom(saved.room,saved.name);
    }catch(e){showLobby(true)}
}
function clearAndShowLobby(){
    showLobby(true);
}

// ============================================
// èƒŒæ™¯éŸ³ä¹ (Web Audio API äº”å£°éŸ³é˜¶ç”Ÿæˆ)
// ============================================
let BGM={ctx:null,gain:null,playing:false,muted:false,timer:null};
// ä¸­å›½äº”å£°éŸ³é˜¶ C D E G A å¤šä¸ªå…«åº¦
const PENTA=[261.6,293.7,329.6,392.0,440.0,523.3,587.3,659.3,784.0,880.0];
const BASS=[130.8,146.8,164.8,196.0,220.0];
// é¢„è®¾æ—‹å¾‹ç‰‡æ®µ(éŸ³ç¬¦ç´¢å¼•), å¾ªç¯æ’­æ”¾
const MELODY=[
    [0,2,4,5, 4,2,0,2],
    [4,5,6,4, 2,0,2,4],
    [2,4,5,7, 5,4,2,0],
    [5,6,7,5, 4,2,4,5],
];

function bgmInit(){
    if(BGM.ctx)return;
    BGM.ctx=new(window.AudioContext||window.webkitAudioContext)();
    // ä¸»éŸ³é‡
    BGM.gain=BGM.ctx.createGain();
    BGM.gain.gain.value=0.12;
    // ç®€æ˜“æ··å“(å»¶è¿Ÿåé¦ˆ)
    let delay=BGM.ctx.createDelay();delay.delayTime.value=0.3;
    let fb=BGM.ctx.createGain();fb.gain.value=0.2;
    let wet=BGM.ctx.createGain();wet.gain.value=0.15;
    delay.connect(fb);fb.connect(delay);delay.connect(wet);wet.connect(BGM.ctx.destination);
    BGM.gain.connect(BGM.ctx.destination);
    BGM.gain.connect(delay);
}

function bgmPlayNote(freq,time,dur,type='triangle',vol=0.25){
    let c=BGM.ctx,o=c.createOscillator(),g=c.createGain();
    o.type=type;o.frequency.value=freq;
    g.gain.setValueAtTime(0,time);
    g.gain.linearRampToValueAtTime(vol,time+0.02);
    g.gain.exponentialRampToValueAtTime(0.001,time+dur);
    o.connect(g);g.connect(BGM.gain);
    o.start(time);o.stop(time+dur+0.05);
}

function bgmSchedule(){
    if(!BGM.playing)return;
    let t=BGM.ctx.currentTime+0.1;
    let mel=MELODY[Math.floor(Math.random()*MELODY.length)];
    let tempo=0.45; // æ¯æ‹æ—¶é•¿
    // æ—‹å¾‹
    for(let i=0;i<mel.length;i++){
        let noteIdx=mel[i];
        // å¶å°”åŠ ç‚¹å˜åŒ–
        if(Math.random()<0.2)noteIdx=PENTA.length-1-noteIdx;
        if(noteIdx<0)noteIdx=0;if(noteIdx>=PENTA.length)noteIdx=PENTA.length-1;
        bgmPlayNote(PENTA[noteIdx],t+i*tempo,tempo*1.2,'triangle',0.18);
    }
    // ä½éŸ³ä¼´å¥(æ¯2æ‹)
    for(let i=0;i<4;i++){
        let bi=Math.floor(Math.random()*BASS.length);
        bgmPlayNote(BASS[bi],t+i*tempo*2,tempo*2.5,'sine',0.1);
    }
    BGM.timer=setTimeout(bgmSchedule,mel.length*tempo*1000);
}

function bgmStart(){
    bgmInit();
    if(BGM.ctx.state==='suspended')BGM.ctx.resume();
    BGM.playing=true;
    bgmSchedule();
    document.getElementById('music-btn').classList.remove('muted');
}

function bgmStop(){
    BGM.playing=false;
    if(BGM.timer){clearTimeout(BGM.timer);BGM.timer=null}
}

function toggleMusic(){
    if(!BGM.ctx){bgmStart();return}
    if(BGM.muted){
        BGM.gain.gain.value=0.12;BGM.muted=false;
        if(!BGM.playing)bgmStart();
        document.getElementById('music-btn').classList.remove('muted');
    }else{
        BGM.gain.gain.value=0;BGM.muted=true;
        document.getElementById('music-btn').classList.add('muted');
    }
}

// éŸ³æ•ˆç³»ç»Ÿ - ä¸åŒç‰Œå‹ä¸åŒå£°éŸ³
function sfxSingle(){
    if(!BGM.ctx||BGM.muted)return;
    let t=BGM.ctx.currentTime;
    bgmPlayNote(660,t,0.1,'triangle',0.08);
}
function sfxPair(){
    if(!BGM.ctx||BGM.muted)return;
    let t=BGM.ctx.currentTime;
    bgmPlayNote(550,t,0.08,'triangle',0.07);
    bgmPlayNote(660,t+0.08,0.08,'triangle',0.07);
}
function sfxTriple(){
    if(!BGM.ctx||BGM.muted)return;
    let t=BGM.ctx.currentTime;
    bgmPlayNote(440,t,0.07,'square',0.06);
    bgmPlayNote(550,t+0.07,0.07,'square',0.06);
    bgmPlayNote(660,t+0.14,0.07,'square',0.06);
}
function sfxTriple1(){
    if(!BGM.ctx||BGM.muted)return;
    let t=BGM.ctx.currentTime;
    bgmPlayNote(440,t,0.06,'square',0.06);
    bgmPlayNote(550,t+0.06,0.06,'square',0.06);
    bgmPlayNote(660,t+0.12,0.06,'square',0.06);
    bgmPlayNote(880,t+0.2,0.06,'triangle',0.04);
}
function sfxFour2(){
    if(!BGM.ctx||BGM.muted)return;
    let t=BGM.ctx.currentTime;
    bgmPlayNote(330,t,0.06,'square',0.07);
    bgmPlayNote(440,t+0.06,0.06,'square',0.07);
    bgmPlayNote(550,t+0.12,0.06,'square',0.07);
    bgmPlayNote(660,t+0.18,0.06,'square',0.07);
    bgmPlayNote(550,t+0.26,0.05,'triangle',0.04);
    bgmPlayNote(440,t+0.31,0.05,'triangle',0.04);
}
function sfxStraight(){
    if(!BGM.ctx||BGM.muted)return;
    let t=BGM.ctx.currentTime;
    let notes=[392,440,494,523,587,660,698,784];
    for(let i=0;i<notes.length;i++)bgmPlayNote(notes[i],t+i*0.04,0.08,'triangle',0.06);
}
function sfxConsecPairs(){
    if(!BGM.ctx||BGM.muted)return;
    let t=BGM.ctx.currentTime;
    let notes=[392,440,523,587,660,784];
    for(let i=0;i<notes.length;i++){bgmPlayNote(notes[i],t+i*0.05,0.09,'triangle',0.05);bgmPlayNote(notes[i]*0.75,t+i*0.05,0.09,'triangle',0.03)}
}
function sfxAirplane(){
    if(!BGM.ctx||BGM.muted)return;
    let t=BGM.ctx.currentTime;
    // é£æœºèµ·é£ä¸Šå‡éŸ³
    let notes=[330,392,440,523,587,660,784,880];
    for(let i=0;i<notes.length;i++)bgmPlayNote(notes[i],t+i*0.035,0.1,'sawtooth',0.04);
    bgmPlayNote(880,t+0.3,0.2,'triangle',0.06);
}
function sfxBomb(){
    if(!BGM.ctx||BGM.muted)return;
    let t=BGM.ctx.currentTime;
    // çˆ†ç‚¸ä½éŸ³å†²å‡»
    for(let i=0;i<6;i++)bgmPlayNote(80+Math.random()*200,t+i*0.03,0.18,'sawtooth',0.09);
    bgmPlayNote(60,t+0.2,0.3,'sine',0.12);
}
function sfxRocket(){
    if(!BGM.ctx||BGM.muted)return;
    let t=BGM.ctx.currentTime;
    // ç«ç®­å‡ç©º + çˆ†ç‚¸
    for(let i=0;i<8;i++)bgmPlayNote(200+i*80,t+i*0.04,0.12,'sawtooth',0.06);
    for(let i=0;i<6;i++)bgmPlayNote(60+Math.random()*250,t+0.35+i*0.03,0.2,'sawtooth',0.1);
    bgmPlayNote(50,t+0.55,0.4,'sine',0.12);
}
function sfxSuperBomb(){
    if(!BGM.ctx||BGM.muted)return;
    let t=BGM.ctx.currentTime;
    // å››ä¸ª3è¶…çº§ç‚¸å¼¹ - ä¸‰è¿çˆ†
    for(let r=0;r<3;r++){
        let off=r*0.2;
        for(let i=0;i<5;i++)bgmPlayNote(60+Math.random()*300,t+off+i*0.03,0.2,'sawtooth',0.08);
    }
    bgmPlayNote(40,t+0.65,0.5,'sine',0.15);
}
function sfxPass(){
    if(!BGM.ctx||BGM.muted)return;
    let t=BGM.ctx.currentTime;
    bgmPlayNote(400,t,0.08,'sine',0.04);
    bgmPlayNote(300,t+0.08,0.12,'sine',0.03);
}

// ============================================
// å¯åŠ¨
// ============================================
window.onload=function(){showLobby(false)};
</script>
</body>
</html>
